---====== Khai báo âm thanh lần 1 ======---
local cue2 = Instance.new("Sound")
cue2.Parent = game.Workspace
cue2.Name = "Spawn_FirstTime"
cue2.SoundId = "rbxassetid://136836151370178"
cue2.Volume = 5
cue2.PlaybackSpeed = 1

if game.Workspace:FindFirstChild("SeekMovingNewClone") then return end

---====== Load spawner ======---
local spawner = loadstring(game:HttpGet("https://raw.githubusercontent.com/Focuslol666/Utilities/refs/heads/patch-1/Doors/Entity%20Spawner/V2/Source.lua"))()

---====== Biến điều khiển ======---
local count = 0
local maxSpawns = 5
local lastRoomTime = tick() 

---====== Hàm đổi đèn xanh dương (Chỉ lần 1) ======---
local function ApplyBlueLights()
    local currentRoomValue = game:GetService("ReplicatedStorage").GameData.LatestRoom.Value
    local roomFolder = game.Workspace.CurrentRooms:FindFirstChild(tostring(currentRoomValue))
    if roomFolder then
        for _, v in pairs(roomFolder:GetDescendants()) do
            if v:IsA("Light") then
                v.Color = Color3.fromRGB(0, 120, 255)
                v.Brightness = 2.5
            end
        end
    end
end

local function SpawnRebound()
    count = count + 1
    if count > maxSpawns then return end

    local isFirstTime = (count == 1)
    
    -- XỬ LÝ ÂM THANH & ĐÈN
    if isFirstTime then
        ApplyBlueLights()
        cue2:Play()
    else
        if cue2 then
            if cue2.Playing then cue2:Stop() end
            cue2:Destroy()
            cue2 = nil
        end
        
        local nextSound = Instance.new("Sound")
        nextSound.Parent = game.Workspace
        nextSound.SoundId = "rbxassetid://71840455801134"
        nextSound.Volume = 5
        nextSound:Play()
        game:GetService("Debris"):AddItem(nextSound, 10)
    end

    ---====== Cấu hình Entity (TẮT ACHIEVEMENTS TRIỆT ĐỂ) ======---
    local entity = spawner.Create({
        Entity = {
            Name = "Rebound",
            Asset = "rbxassetid://12304843796",
            HeightOffset = 0
        },
        Lights = { Flicker = { Enabled = true, Duration = 2 }, Shatter = true, Repair = false },
        CameraShake = {
            Enabled = isFirstTime, 
            Range = 100,
            Values = {3.5, 20, 0.1, 1} 
        },
        Movement = { Speed = 220, Delay = 7, Reversed = true },
        Rebounding = { Enabled = false }, 
        Damage = { 
            Enabled = true, 
            Range = 65, 
            Amount = 150 
        },
        Jumpscare = { Enabled = true, Sound = "rbxassetid://18459521002", SoundVolume = 5 },
        Crucifixion = { Enabled = true, Range = 10, Resist = false, Break = true },
        
        --- KHÓA TOÀN BỘ ACHIEVEMENTS TẠI ĐÂY ---
        Achievements = {
            Survive = { Enabled = false },
            Crucifix = { Enabled = false },
            Death = { Enabled = false }
        },
        
        Death = { 
            Cause = "Rebound",
            Hints = {"You died to Rebound...", "It appears at the next door and has a chance to stay there or run back to the latest door.", "He will come back many times after his initial spawn", "so hide every next door until it is safe.."} 
        }
    })

    ---====== Hiệu ứng Rung Camera Di Chuyển & Kill Logic ======---
    entity:SetCallback("OnStartMoving", function()
        local player = game.Players.LocalPlayer
        local character = player.Character
        if character and character:FindFirstChild("HumanoidRootPart") then
            task.spawn(function()
                while entity and entity:IsMoving() do
                    local entityModel = game.Workspace:FindFirstChild("Rebound")
                    if entityModel and entityModel:FindFirstChild("PrimaryPart") then
                        local distance = (character.HumanoidRootPart.Position - entityModel.PrimaryPart.Position).Magnitude
                        
                        -- Rung camera trong phạm vi 100 studs
                        if distance <= 100 then
                            local intensity = math.clamp((100 - distance) / 25, 0.3, 3.5)
                            spawner.Shake({intensity, 20, 0.1, 0.1}, 100)
                        end

                        -- Kiểm tra tiêu diệt (Range 65)
                        if distance < 65 and not character:GetAttribute("Hiding") then
                            character.Humanoid.Health = 0
                        end
                    end
                    task.wait(0.1)
                end
            end)
        end
    end)

    local targetRoom = game:GetService("ReplicatedStorage").GameData.LatestRoom.Value + 1
    entity:Run(targetRoom)
end

---====== Logic Kích Hoạt Qua Phòng ======---
task.wait(0.2)
SpawnRebound()
lastRoomTime = tick() 

local latestRoom = game:GetService("ReplicatedStorage").GameData.LatestRoom
latestRoom.Changed:Connect(function()
    local timeSpentInRoom = tick() - lastRoomTime 
    
    if count < maxSpawns then
        if timeSpentInRoom >= 4 then
            task.wait(0.5) 
            SpawnRebound()
        end
    end
    
    lastRoomTime = tick()
end)
